import{a as le,b as me,c as ce,g as de}from"./chunk-3PZUR2DF.js";import{a as se,b as ne,c as re}from"./chunk-PFE5ME3B.js";import{a as te,b as ie}from"./chunk-V3KS4TSK.js";import"./chunk-HKVI4RXP.js";import"./chunk-CP6ZTTNU.js";import{a as ee}from"./chunk-TSMETG7O.js";import{e as X,f as Z}from"./chunk-KEGNGRCI.js";import"./chunk-4YRY4IP2.js";import{c as W,f as q,i as H,t as K}from"./chunk-LBDSJBCK.js";import{Ga as G,La as J,Na as Y,Oa as oe,Pa as ae,i as $,k as z,l as L,o as Q,ra as M}from"./chunk-SFRASIIN.js";import{Eb as w,Fb as S,Gb as T,Ic as A,Jb as k,Jc as N,Kb as d,Lb as x,Mb as y,Oa as R,Pc as j,Qb as P,Ra as n,Rb as U,Sa as _,Sb as O,Tb as E,Ub as F,Vc as D,ca as I,dc as B,eb as g,ec as V,hb as l,jb as C,la as h,ma as f,qb as r,rb as o,sb as p,wb as b,xb as v,yb as m}from"./chunk-D3OC6ZHD.js";var ue=["messageContainer"],he=["fileUpload"];function fe(s,t){s&1&&(r(0,"small",23),p(1,"i",24),d(2," Online "),o())}function ve(s,t){if(s&1&&(r(0,"div",25),p(1,"i",26),d(2),o()),s&2){let e=m();n(2),y(" ",e.getTypingText()," ")}}function _e(s,t){s&1&&(r(0,"div",27),p(1,"i",28),o())}function be(s,t){s&1&&(r(0,"div",29)(1,"p",23),d(2,"No messages yet. Start the conversation!"),o()())}function xe(s,t){if(s&1&&p(0,"p-avatar",46),s&2){let e=m().$implicit,i=m();l("label",i.getUserInitials(e.sender))}}function ye(s,t){if(s&1&&(r(0,"div",47)(1,"small",48),d(2),o()()),s&2){let e=m().$implicit,i=m();n(2),x(i.getUserFullName(e.sender))}}function Ce(s,t){if(s&1&&(r(0,"div",49),d(1),o()),s&2){let e=m().$implicit;n(),y(" ",e.content," ")}}function Me(s,t){if(s&1){let e=b();r(0,"div",50)(1,"img",51),v("click",function(){h(e);let a=m().$implicit,c=m();return f(c.openImage(a.attachment.url))}),o()()}if(s&2){let e=m().$implicit;n(),l("src",e.attachment.url,R)("alt",e.attachment.name)}}function we(s,t){if(s&1){let e=b();r(0,"div",52)(1,"div",53),p(2,"i",54),r(3,"div",19)(4,"div",55),d(5),o(),r(6,"small",23),d(7),o()(),r(8,"button",56),v("click",function(){h(e);let a=m().$implicit,c=m();return f(c.downloadAttachment(a))}),o()()()}if(s&2){let e=m().$implicit,i=m();n(5),x(e.attachment.name),n(2),x(i.formatFileSize(e.attachment.size))}}function Se(s,t){s&1&&p(0,"i",57)}function Te(s,t){s&1&&p(0,"i",58)}function Ie(s,t){if(s&1){let e=b();r(0,"button",59),v("click",function(a){h(e);let c=m().$implicit,u=k(17),ge=m();return u.toggle(a),f(ge.setActiveMessage(c))}),o()}s&2&&l("pTooltip","Actions")}function Re(s,t){if(s&1&&(r(0,"div",30)(1,"div",31),g(2,xe,1,1,"p-avatar",32),r(3,"div",33),g(4,ye,3,1,"div",34),r(5,"div",35),g(6,Ce,2,1,"div",36)(7,Me,2,2,"div",37)(8,we,9,2,"div",38),o(),r(9,"div",39)(10,"small",40),d(11),o(),r(12,"div",41),g(13,Se,1,0,"i",42)(14,Te,1,0,"i",43),o()()(),g(15,Ie,1,1,"button",44),p(16,"p-menu",45,1),o()()),s&2){let e=t.$implicit,i=m();C("wrapper-sent",e.sender.id===i.currentUserId)("wrapper-received",e.sender.id!==i.currentUserId),n(),C("sent",e.sender.id===i.currentUserId)("received",e.sender.id!==i.currentUserId),n(),l("ngIf",e.sender.id!==i.currentUserId),n(2),l("ngIf",e.sender.id!==i.currentUserId),n(2),l("ngIf",e.content),n(),l("ngIf",e.attachment&&e.message_type==="image"),n(),l("ngIf",e.attachment&&e.message_type==="file"),n(3),y(" ",i.formatMessageTime(e.created_at)," "),n(2),l("ngIf",e.sender.id===i.currentUserId&&i.isMessageRead(e)),n(),l("ngIf",e.sender.id===i.currentUserId&&!i.isMessageRead(e)),n(),l("ngIf",e.sender.id===i.currentUserId),n(),l("popup",!0)("model",i.getMessageActions())}}function ke(s,t){if(s&1&&(r(0,"div",60),p(1,"p-progressBar",61),o()),s&2){let e=m();n(),l("value",e.uploadProgress)("showValue",!0)}}function Pe(s,t){if(s&1){let e=b();r(0,"div",62)(1,"div",63)(2,"div",7),p(3,"i",64),r(4,"span"),d(5),o(),r(6,"small",23),d(7),o()(),r(8,"button",65),v("click",function(){h(e);let a=m();return f(a.clearSelectedFile())}),o()()()}if(s&2){let e=m();n(5),x(e.selectedFile.name),n(2),y("(",e.formatFileSize(e.selectedFile.size),")")}}var pe=class s{constructor(t,e,i,a,c){this.route=t;this.router=e;this.chatService=i;this.tokenService=a;this.messageService=c}messageContainer;fileUpload;messages=[];newMessage="";loading=!1;uploading=!1;uploadProgress=0;currentUserId;chatRoom;selectedFile;activeMessage;messageSubscription;typingSubscription;onlineUsersSubscription;currentlyTyping=[];onlineUsers=[];typingTimer;shouldScrollToBottom=!0;username="";userInitials="";ngOnInit(){let t=this.tokenService.getCurrentUser();this.currentUserId=t?.id;let e=this.route.snapshot.params.id;if(!e){this.router.navigate(["/dashboard/messages"]);return}this.username=this.route.snapshot.queryParams.userName||"",this.userInitials=this.route.snapshot.queryParams.userInitials||"",this.loadChatRoom(e),this.loadMessages(e),this.setupWebSocket(e),this.subscribeToNewMessages(),this.subscribeToTypingIndicators(),this.subscribeToOnlineUsers()}ngOnDestroy(){this.messageSubscription&&this.messageSubscription.unsubscribe(),this.typingSubscription&&this.typingSubscription.unsubscribe(),this.onlineUsersSubscription&&this.onlineUsersSubscription.unsubscribe(),this.typingTimer&&clearTimeout(this.typingTimer),this.chatService.disconnectWebSocket()}ngAfterViewChecked(){this.shouldScrollToBottom&&this.scrollToBottom()}loadChatRoom(t){}setupWebSocket(t){this.chatService.connectToRoom(t)}subscribeToNewMessages(){this.messageSubscription=this.chatService.messages$.subscribe(t=>{this.messages=t,this.shouldScrollToBottom=!0,this.markRoomAsRead()})}subscribeToTypingIndicators(){this.typingSubscription=this.chatService.typing$.subscribe(t=>{t.user_id!==this.currentUserId&&(t.is_typing?this.currentlyTyping.find(i=>i.user_id===t.user_id)||this.currentlyTyping.push(t):this.currentlyTyping=this.currentlyTyping.filter(e=>e.user_id!==t.user_id))})}subscribeToOnlineUsers(){this.onlineUsersSubscription=this.chatService.onlineUsers$.subscribe(t=>{this.onlineUsers=t})}loadMessages(t){this.loading=!0,this.chatService.getRoomMessages(t).subscribe({next:e=>{let i=e.results||e;this.messages=Array.isArray(i)?i:[],this.chatService.setMessages(this.messages),this.loading=!1,this.shouldScrollToBottom=!0,this.markRoomAsRead(),console.log("Messages loaded:",this.messages)},error:e=>{console.error("Error loading messages:",e),this.messageService.add({severity:"error",summary:"Error",detail:"Failed to load messages"}),this.loading=!1}})}sendMessage(){if(!this.newMessage.trim()&&!this.selectedFile||!this.route.snapshot.params.id)return;let t=this.route.snapshot.params.id;this.uploading=!0,this.chatService.sendMessage(t,this.newMessage,this.selectedFile).subscribe({next:e=>{this.newMessage="",this.selectedFile=void 0,this.uploading=!1,this.uploadProgress=0,this.fileUpload&&this.fileUpload.clear(),this.shouldScrollToBottom=!0,this.chatService.sendTypingIndicator(!1)},error:e=>{console.error("Error sending message:",e),this.messageService.add({severity:"error",summary:"Error",detail:"Failed to send message"}),this.uploading=!1,this.uploadProgress=0}})}onEnterPress(t){let e=t;e.key==="Enter"&&!e.shiftKey&&(t.preventDefault(),this.sendMessage())}clearSelectedFile(){this.selectedFile=void 0,this.fileUpload&&this.fileUpload.clear()}onTyping(){this.chatService.sendTypingIndicator(!0),this.typingTimer&&clearTimeout(this.typingTimer),this.typingTimer=setTimeout(()=>{this.chatService.sendTypingIndicator(!1)},2e3)}downloadAttachment(t){t.attachment&&this.chatService.downloadAttachment(t.id).subscribe({next:e=>{let i=window.URL.createObjectURL(e),a=document.createElement("a");a.href=i,a.download=t.attachment?.name||"attachment",a.click(),window.URL.revokeObjectURL(i)},error:e=>{console.error("Error downloading attachment:",e),this.messageService.add({severity:"error",summary:"Error",detail:"Failed to download attachment"})}})}openImage(t){window.open(t,"_blank")}markRoomAsRead(){let t=this.route.snapshot.params.id;t&&this.chatService.markRoomAsRead(t).subscribe()}setActiveMessage(t){this.activeMessage=t}getMessageActions(){return[{label:"Delete",icon:"pi pi-trash",command:()=>this.deleteMessage()}]}deleteMessage(){this.activeMessage&&this.chatService.deleteMessage(this.activeMessage.id).subscribe({next:()=>{this.messages=this.messages.filter(t=>t.id!==this.activeMessage.id),this.chatService.setMessages(this.messages),this.messageService.add({severity:"success",summary:"Success",detail:"Message deleted"}),this.activeMessage=void 0},error:t=>{console.error("Error deleting message:",t),this.messageService.add({severity:"error",summary:"Error",detail:"Failed to delete message"})}})}isMessageRead(t){return this.chatRoom?this.chatRoom.participants.filter(i=>i.id!==this.currentUserId).some(i=>t.read_by.includes(i.id)):!1}isParticipantOnline(){if(!this.chatRoom)return!1;let t=this.chatRoom.participants.find(e=>e.id!==this.currentUserId);return t?this.onlineUsers.includes(t.id):!1}getParticipantName(){if(console.log(this.chatRoom),!this.chatRoom)return"";let t=this.chatRoom.participants.find(e=>e.id!==this.currentUserId);return console.log(t),t?t.display_name:"Unknown User"}getUserFullName(t){return t.first_name&&t.last_name&&t.first_name.trim()&&t.last_name.trim()?`${t.first_name.trim()} ${t.last_name.trim()}`:t.username}getUserInitials(t){return this.getUserFullName(t).split(" ").map(i=>i[0]).join("").toUpperCase().substring(0,2)}getAvatarColor(){if(!this.chatRoom)return"#2196F3";let t=["#2196F3","#4CAF50","#FF9800","#E91E63","#9C27B0","#00BCD4","#FFEB3B","#795548"],e=this.chatRoom.participants.find(i=>i.id!==this.currentUserId);return t[e?e.id%t.length:0]}getTypingText(){return this.currentlyTyping.length===1?`${this.currentlyTyping[0].username} is typing...`:this.currentlyTyping.length>1?"Multiple people are typing...":""}getHeaderUserInitials(){if(this.userInitials)return this.userInitials;if(this.username)return this.username.split(" ").map(e=>e[0]).join("").toUpperCase().substring(0,2);if(!this.chatRoom)return"";let t=this.chatRoom.participants.find(e=>e.id!==this.currentUserId);return t?this.getUserFullName(t).split(" ").map(i=>i[0]).join("").toUpperCase().substring(0,2):"U"}formatFileSize(t){if(t===0)return"0 Bytes";let e=1024,i=["Bytes","KB","MB","GB"],a=Math.floor(Math.log(t)/Math.log(e));return parseFloat((t/Math.pow(e,a)).toFixed(2))+" "+i[a]}formatMessageTime(t){let e=t||new Date().toISOString(),i=new Date(e),c=(new Date().getTime()-i.getTime())/(1e3*60*60);if(c<1){let u=Math.floor(c*60);return u<1?"Just now":`${u}m ago`}else return c<24?i.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):c<48?`Yesterday ${i.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}`:i.toLocaleDateString([],{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}scrollToBottom(){try{let t=this.messageContainer.nativeElement;t.scrollTop=t.scrollHeight,this.shouldScrollToBottom=!1}catch{}}static \u0275fac=function(e){return new(e||s)(_($),_(z),_(re),_(ee),_(M))};static \u0275cmp=I({type:s,selectors:[["app-chat-room"]],viewQuery:function(e,i){if(e&1&&(w(ue,5),w(he,5)),e&2){let a;S(a=T())&&(i.messageContainer=a.first),S(a=T())&&(i.fileUpload=a.first)}},standalone:!0,features:[E([M]),F],decls:26,vars:17,consts:[["messageContainer",""],["messageMenu",""],[1,"grid"],[1,"col-12"],[1,"flex","justify-content-between","align-items-center","mb-4"],[1,"flex","align-items-center","gap-3"],["pButton","","icon","pi pi-arrow-left","routerLink","/dashboard/messages",1,"p-button-text"],[1,"flex","align-items-center","gap-2"],[1,"flex","flex-column"],[1,"font-bold"],["class","text-500",4,"ngIf"],["class","text-500 text-sm",4,"ngIf"],[1,"messages-container"],["class","flex justify-content-center p-4",4,"ngIf"],["class","text-center p-4",4,"ngIf"],["class","message-wrapper",3,"wrapper-sent","wrapper-received",4,"ngFor","ngForOf"],["class","upload-progress mb-2",4,"ngIf"],[1,"message-input"],[1,"flex","gap-2"],[1,"flex-1"],["pInputTextarea","","placeholder","Type a message...",1,"w-full",3,"ngModelChange","keydown.enter","ngModel","rows","autoResize"],["pButton","","icon","pi pi-send",3,"click","disabled","loading"],["class","selected-file mt-2 p-2 border-round surface-border border-1",4,"ngIf"],[1,"text-500"],[1,"pi","pi-circle-fill","text-green-500",2,"font-size","0.5rem"],[1,"text-500","text-sm"],[1,"pi","pi-ellipsis-h"],[1,"flex","justify-content-center","p-4"],[1,"pi","pi-spin","pi-spinner","text-xl"],[1,"text-center","p-4"],[1,"message-wrapper"],[1,"message"],["size","normal","class","mr-2","styleClass","bg-primary-100 text-primary-700",3,"label",4,"ngIf"],[1,"message-bubble"],["class","sender-name mb-1",4,"ngIf"],[1,"message-content"],["class","message-text",4,"ngIf"],["class","attachment-image mt-2",4,"ngIf"],["class","attachment-file mt-2",4,"ngIf"],[1,"message-info","flex","align-items-center","justify-content-between","mt-1"],[1,"message-time","text-500"],[1,"message-status"],["class","pi pi-check-double text-primary","pTooltip","Read",4,"ngIf"],["class","pi pi-check text-500","pTooltip","Sent",4,"ngIf"],["pButton","","icon","pi pi-ellipsis-v","class","p-button-text p-button-sm message-actions ml-2",3,"pTooltip","click",4,"ngIf"],[3,"popup","model"],["size","normal","styleClass","bg-primary-100 text-primary-700",1,"mr-2",3,"label"],[1,"sender-name","mb-1"],[1,"text-600","font-medium"],[1,"message-text"],[1,"attachment-image","mt-2"],[1,"max-w-full","h-auto","border-round","cursor-pointer",3,"click","src","alt"],[1,"attachment-file","mt-2"],[1,"flex","align-items-center","gap-2","p-2","border-round","surface-border","border-1"],[1,"pi","pi-file","text-primary"],[1,"font-medium"],["pButton","","icon","pi pi-download","pTooltip","Download",1,"p-button-text","p-button-sm",3,"click"],["pTooltip","Read",1,"pi","pi-check-double","text-primary"],["pTooltip","Sent",1,"pi","pi-check","text-500"],["pButton","","icon","pi pi-ellipsis-v",1,"p-button-text","p-button-sm","message-actions","ml-2",3,"click","pTooltip"],[1,"upload-progress","mb-2"],[3,"value","showValue"],[1,"selected-file","mt-2","p-2","border-round","surface-border","border-1"],[1,"flex","align-items-center","justify-content-between"],[1,"pi","pi-file"],["pButton","","icon","pi pi-times",1,"p-button-text","p-button-sm",3,"click"]],template:function(e,i){if(e&1){let a=b();r(0,"div",2)(1,"div",3)(2,"p-card")(3,"div",4)(4,"div",5),p(5,"button",6),r(6,"div",7)(7,"div",8)(8,"span",9),d(9),B(10,"titlecase"),o(),g(11,fe,3,0,"small",10),o()()(),g(12,ve,3,1,"div",11),o(),r(13,"div",12,0),g(15,_e,2,0,"div",13)(16,be,3,0,"div",14)(17,Re,18,19,"div",15),o(),g(18,ke,2,2,"div",16),r(19,"div",17)(20,"div",18)(21,"div",19)(22,"textarea",20),O("ngModelChange",function(u){return h(a),U(i.newMessage,u)||(i.newMessage=u),f(u)}),v("ngModelChange",function(){return h(a),f(i.onTyping())})("keydown.enter",function(u){return h(a),f(i.onEnterPress(u))}),d(23,"                "),o()(),r(24,"button",21),v("click",function(){return h(a),f(i.sendMessage())}),o()(),g(25,Pe,9,2,"div",22),o()()()()}e&2&&(n(9),x(V(10,15,i.username||i.getParticipantName())),n(2),l("ngIf",i.isParticipantOnline()),n(),l("ngIf",i.currentlyTyping.length>0),n(),C("loading",i.loading),n(2),l("ngIf",i.loading),n(),l("ngIf",!i.loading&&i.messages.length===0),n(),l("ngForOf",i.messages),n(),l("ngIf",i.uploadProgress>0&&i.uploadProgress<100),n(4),P("ngModel",i.newMessage),l("rows",1)("autoResize",!0),n(2),l("disabled",!i.newMessage.trim()&&!i.selectedFile||i.uploading)("loading",i.uploading),n(),l("ngIf",i.selectedFile))},dependencies:[D,A,N,j,Q,L,K,W,q,H,Y,J,ae,oe,ce,ne,se,de,Z,X,ie,te,G,me,le],styles:["[_nghost-%COMP%]{display:block;height:100%;overflow:hidden}.grid[_ngcontent-%COMP%]{height:100vh;margin:0;padding:1rem;overflow:hidden}.grid[_ngcontent-%COMP%]   .col-12[_ngcontent-%COMP%]{height:100%;overflow:hidden;padding:0}[_nghost-%COMP%]     .p-card{height:100%;max-height:100%;margin:0}[_nghost-%COMP%]     .p-card .p-card-body{height:100%;max-height:100%;display:flex;flex-direction:column;overflow:hidden;margin-bottom:25px}[_nghost-%COMP%]     .p-card .p-card-body .p-card-content{flex:1;display:flex;flex-direction:column;padding:0!important;overflow:hidden;min-height:0}[_nghost-%COMP%]     .messages-container{flex:1;overflow-y:auto;overflow-x:hidden;padding:1rem;background-color:var(--surface-ground);min-height:0;max-height:100%;scroll-behavior:smooth}[_nghost-%COMP%]     .messages-container.loading{display:flex;align-items:center;justify-content:center}[_nghost-%COMP%]     .messages-container::-webkit-scrollbar{width:6px}[_nghost-%COMP%]     .messages-container::-webkit-scrollbar-track{background:var(--surface-100);border-radius:3px}[_nghost-%COMP%]     .messages-container::-webkit-scrollbar-thumb{background:var(--surface-300);border-radius:3px}[_nghost-%COMP%]     .messages-container::-webkit-scrollbar-thumb:hover{background:var(--surface-400)}[_nghost-%COMP%]     .message-wrapper{margin-bottom:1rem;display:flex;position:relative}[_nghost-%COMP%]     .message-wrapper.wrapper-sent{justify-content:flex-end}[_nghost-%COMP%]     .message-wrapper.wrapper-received{justify-content:flex-start}[_nghost-%COMP%]     .message{display:flex;align-items:flex-end;max-width:70%;position:relative}[_nghost-%COMP%]     .message .message-bubble{display:flex;flex-direction:column;max-width:100%}[_nghost-%COMP%]     .message .sender-name{padding:0 .5rem}[_nghost-%COMP%]     .message .message-content{padding:.75rem 1rem;border-radius:1.25rem;background-color:var(--surface-card);box-shadow:0 1px 2px #0000001a;word-wrap:break-word;position:relative}[_nghost-%COMP%]     .message .message-info{padding:0 .5rem;margin-top:.25rem}[_nghost-%COMP%]     .message .message-time{font-size:.75rem}[_nghost-%COMP%]     .message .message-actions{opacity:0;transition:opacity .2s}[_nghost-%COMP%]     .message:hover .message-actions{opacity:1}[_nghost-%COMP%]     .message.sent{flex-direction:row}[_nghost-%COMP%]     .message.sent .message-content{background-color:var(--primary-color);color:var(--primary-color-text);border-bottom-right-radius:.5rem}[_nghost-%COMP%]     .message.sent .message-info{text-align:right}[_nghost-%COMP%]     .message.sent .message-time{color:var(--primary-100)}[_nghost-%COMP%]     .message.received{flex-direction:row}[_nghost-%COMP%]     .message.received .message-content{background-color:var(--surface-card);color:var(--text-color);border-bottom-left-radius:.5rem}[_nghost-%COMP%]     .message.received .message-info{text-align:left}[_nghost-%COMP%]     .message-input{flex-shrink:0;padding:1rem;background-color:var(--surface-card);border-top:1px solid var(--surface-border);max-height:200px;overflow-y:auto;margin-bottom:15px}[_nghost-%COMP%]     .message-input .p-inputtextarea{resize:none;max-height:120px;overflow-y:auto}[_nghost-%COMP%]     .message-input .selected-file{max-height:60px;overflow:hidden}[_nghost-%COMP%]     .attachment{padding:.5rem;background-color:#0000001a;border-radius:.5rem}"]})};export{pe as ChatRoomComponent};
