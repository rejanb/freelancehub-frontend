import{a as oe,b as ne}from"./chunk-XY5JJY4Z.js";import{a as X,b as Z,c as ee}from"./chunk-PFE5ME3B.js";import"./chunk-HKVI4RXP.js";import{a as K}from"./chunk-TSMETG7O.js";import{a as V,b as G,c as H,d as J}from"./chunk-NULHEHFH.js";import{c as U,f as j,i as Q,t as $}from"./chunk-LBDSJBCK.js";import{Fa as q,Ga as z,La as W,Na as Y,Oa as te,Pa as ie,l as D,o as N,ra as f}from"./chunk-SFRASIIN.js";import{Ic as O,Jc as L,Kb as l,Lb as x,Mb as g,Ob as y,Qb as S,Qc as A,Ra as r,Rb as M,Sa as u,Sb as R,Tb as I,Ub as T,Vb as k,Vc as B,Wb as v,Xb as P,ca as C,dc as w,eb as h,fc as E,hb as s,kb as b,pc as F,qb as n,rb as a,sb as m,xb as _,yb as d}from"./chunk-D3OC6ZHD.js";var re=()=>[1,2,3,4,5],se=t=>["/dashboard/messages",t],ce=(t,i)=>({userName:t,userInitials:i}),le=t=>({"background-color":t});function me(t,i){t&1&&(n(0,"div",16),m(1,"p-skeleton",17),n(2,"div",18),m(3,"p-skeleton",19)(4,"p-skeleton",20),a()())}function de(t,i){t&1&&(n(0,"div",14),h(1,me,5,0,"div",15),a()),t&2&&(r(),s("ngForOf",k(1,re)))}function pe(t,i){if(t&1&&(n(0,"div",21)(1,"small",22),l(2),a()()),t&2){let e=d();r(2),y(" Chat rooms loaded: ",(e.chatRooms==null?null:e.chatRooms.length)||0," | Array initialized: ",e.chatRooms?"Yes":"No",' | Search query: "',e.searchQuery,'" ')}}function he(t,i){if(t&1&&(n(0,"small",22),l(1),w(2,"date"),a()),t&2){let e=d().$implicit;r(),g(" ",E(2,1,e.last_message==null?null:e.last_message.created_at,"shortTime")," ")}}function ue(t,i){if(t&1&&(n(0,"span"),m(1,"i",34),l(2),a()),t&2){let e=d().$implicit;r(2),g(" ",e.last_message==null||e.last_message.attachment==null?null:e.last_message.attachment.name," ")}}function ge(t,i){if(t&1&&(n(0,"span"),l(1),a()),t&2){let e=d().$implicit;r(),g(" ",e.last_message==null?null:e.last_message.content," ")}}function fe(t,i){t&1&&(n(0,"span"),l(1," No messages yet "),a())}function _e(t,i){if(t&1&&m(0,"p-badge",35),t&2){let e=d().$implicit;s("value",e.unread_count.toString())}}function ve(t,i){if(t&1&&(n(0,"div",25),m(1,"p-avatar",26),n(2,"div",18)(3,"div",27)(4,"span",28),l(5),a(),h(6,he,3,4,"small",29),a(),n(7,"div",30)(8,"span",31),h(9,ue,3,1,"span",32)(10,ge,2,1,"span",32)(11,fe,2,0,"span",32),a(),h(12,_e,1,1,"p-badge",33),a()()()),t&2){let e=i.$implicit,o=d(2);s("routerLink",v(11,se,e.id))("queryParams",P(13,ce,o.getParticipantName(e),o.getParticipantInitials(e))),r(),b(v(16,le,o.getAvatarColor(e))),s("label",o.getParticipantInitials(e)),r(4),x(o.getParticipantName(e)),r(),s("ngIf",e.last_message==null?null:e.last_message.created_at),r(3),s("ngIf",(e.last_message==null?null:e.last_message.attachment)&&!(e.last_message!=null&&e.last_message.content)),r(),s("ngIf",e.last_message==null?null:e.last_message.content),r(),s("ngIf",!e.last_message),r(),s("ngIf",e.unread_count>0)}}function Ce(t,i){if(t&1&&(n(0,"div",23),h(1,ve,13,18,"div",24),a()),t&2){let e=d();r(),s("ngForOf",e.chatRooms)("ngForTrackBy",e.trackByRoomId)}}function be(t,i){t&1&&(n(0,"div",36),m(1,"i",37),n(2,"h3"),l(3,"No Messages Yet"),a(),n(4,"p",22),l(5,"Start a conversation from a user's profile or job proposal."),a()())}var ae=class t{constructor(i,e,o,c){this.chatService=i;this.tokenService=e;this.messageService=o;this.cdr=c;this.chatRooms=[]}chatRooms=[];loading=!1;searchQuery="";searchTimeout;currentUserId;unreadSubscription;chatRoomsSubscription;ngOnInit(){let i=this.tokenService.getCurrentUser();this.currentUserId=i?.id,this.loadChatRooms(),this.subscribeToUnreadCount(),this.subscribeToChatRooms(),this.chatService.loadUnreadCount()}ngOnDestroy(){this.searchTimeout&&clearTimeout(this.searchTimeout),this.unreadSubscription&&this.unreadSubscription.unsubscribe(),this.chatRoomsSubscription&&this.chatRoomsSubscription.unsubscribe()}subscribeToChatRooms(){this.chatRoomsSubscription=this.chatService.chatRooms$.subscribe(i=>{console.log("Chat rooms updated:",i),this.chatRooms=Array.isArray(i)?i:[],this.cdr.detectChanges()})}subscribeToUnreadCount(){this.unreadSubscription=this.chatService.unreadCount$.subscribe(i=>{console.log("Unread count updated:",i),this.cdr.detectChanges()})}loadChatRooms(){console.log("Loading chat rooms..."),this.loading=!0,this.chatRooms=[],this.cdr.detectChanges(),this.chatService.getChatRooms().subscribe({next:i=>{console.log("Chat rooms response:",i);let e=i.results||i;this.chatRooms=Array.isArray(e)?e:[],this.chatService.setChatRooms(this.chatRooms),this.loading=!1,this.cdr.detectChanges()},error:i=>{console.error("Error loading chat rooms:",i),this.chatRooms=[],this.messageService.add({severity:"error",summary:"Error",detail:"Failed to load messages"}),this.loading=!1,this.cdr.detectChanges()}})}onSearch(i){this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(()=>{this.searchQuery.trim()?(this.loading=!0,this.chatService.searchMessages(this.searchQuery).subscribe({next:e=>{let o=new Map;e.results&&e.results.forEach(c=>{if(c.chat_room&&!o.has(c.chat_room)){let p={id:c.chat_room,participants:[c.sender],is_group:!1,last_message:c,unread_count:0,created_at:c.created_at,updated_at:c.updated_at};o.set(c.chat_room,p)}}),this.chatRooms=Array.from(o.values()),this.loading=!1,this.cdr.detectChanges()},error:e=>{console.error("Error searching messages:",e),this.chatRooms=[],this.loading=!1,this.cdr.detectChanges()}})):this.loadChatRooms()},300)}getParticipantName(i){let e=i.participants.find(o=>o.id!==this.currentUserId);return e?e.first_name&&e.last_name&&e.first_name.trim()&&e.last_name.trim()?`${e.first_name.trim()} ${e.last_name.trim()}`:e.username:"Unknown User"}getParticipantInitials(i){return this.getParticipantName(i).split(" ").map(o=>o[0]).join("").toUpperCase()}getAvatarColor(i){let e=["#2196F3","#4CAF50","#FF9800","#E91E63","#9C27B0","#00BCD4","#FFEB3B","#795548"],o=i.participants.find(c=>c.id!==this.currentUserId);return e[o?o.id%e.length:0]}trackByRoomId(i,e){return e.id}debugChatRooms(){console.log("Current chat rooms state:",{array:this.chatRooms,length:this.chatRooms?.length,isArray:Array.isArray(this.chatRooms),loading:this.loading})}static \u0275fac=function(e){return new(e||t)(u(ee),u(K),u(f),u(F))};static \u0275cmp=C({type:t,selectors:[["app-message-list"]],standalone:!0,features:[I([f]),T],decls:17,vars:5,consts:[[1,"grid"],[1,"col-12"],[1,"flex","justify-content-between","align-items-center","mb-4"],[1,"m-0"],[1,"flex","gap-2","align-items-center"],["pButton","","type","button","icon","pi pi-refresh","title","Debug chat rooms",1,"p-button-outlined","p-button-sm",3,"click"],["styleClass","w-full","iconPosition","left"],[1,"pi","pi-search"],["type","text","pInputText","","placeholder","Search messages...",1,"w-full",3,"ngModelChange","input","ngModel"],[1,"chat-rooms-container"],["class","flex flex-column gap-3 p-3",4,"ngIf"],["class","mb-3 p-2 surface-100 border-round",4,"ngIf"],["class","flex flex-column",4,"ngIf"],["class","text-center p-5",4,"ngIf"],[1,"flex","flex-column","gap-3","p-3"],["class","flex gap-3 p-3",4,"ngFor","ngForOf"],[1,"flex","gap-3","p-3"],["shape","circle","size","4rem"],[1,"flex-1"],["width","70%","height","1.5rem","styleClass","mb-2"],["width","40%","height","1rem"],[1,"mb-3","p-2","surface-100","border-round"],[1,"text-500"],[1,"flex","flex-column"],["class","chat-room-item flex align-items-center p-3 cursor-pointer border-bottom-1 surface-border",3,"routerLink","queryParams",4,"ngFor","ngForOf","ngForTrackBy"],[1,"chat-room-item","flex","align-items-center","p-3","cursor-pointer","border-bottom-1","surface-border",3,"routerLink","queryParams"],["shape","circle","size","large",1,"mr-3",3,"label"],[1,"flex","justify-content-between","align-items-center"],[1,"font-bold"],["class","text-500",4,"ngIf"],[1,"flex","justify-content-between","align-items-center","mt-2"],[1,"text-500","text-overflow-ellipsis",2,"max-width","80%"],[4,"ngIf"],["severity","danger",3,"value",4,"ngIf"],[1,"pi","pi-paperclip","mr-1"],["severity","danger",3,"value"],[1,"text-center","p-5"],[1,"pi","pi-comments","text-6xl","text-500","mb-3"]],template:function(e,o){e&1&&(n(0,"div",0)(1,"div",1)(2,"p-card")(3,"div",2)(4,"h2",3),l(5,"Messages"),a(),n(6,"div",4)(7,"button",5),_("click",function(){return o.debugChatRooms()}),a(),n(8,"p-iconfield",6)(9,"p-inputicon"),m(10,"i",7),a(),n(11,"input",8),R("ngModelChange",function(p){return M(o.searchQuery,p)||(o.searchQuery=p),p}),_("input",function(p){return o.onSearch(p)}),a()()()(),n(12,"div",9),h(13,de,2,2,"div",10)(14,pe,3,3,"div",11)(15,Ce,2,2,"div",12)(16,be,6,0,"div",13),a()()()()),e&2&&(r(11),S("ngModel",o.searchQuery),r(2),s("ngIf",o.loading),r(),s("ngIf",!o.loading),r(),s("ngIf",!o.loading&&o.chatRooms&&o.chatRooms.length>0),r(),s("ngIf",!o.loading&&(!o.chatRooms||o.chatRooms.length===0)))},dependencies:[B,O,L,A,N,D,$,U,j,Q,Y,W,ie,te,J,H,Z,X,z,q,ne,oe,V,G],styles:["[_nghost-%COMP%]{display:block;height:100%}.grid[_ngcontent-%COMP%]{height:100vh;margin:0;padding:1rem;overflow:hidden}.grid[_ngcontent-%COMP%]   .col-12[_ngcontent-%COMP%]{height:100%;overflow:hidden;padding:0}[_nghost-%COMP%]     .p-card{height:100%;max-height:100%;margin:0}[_nghost-%COMP%]     .p-card .p-card-body{height:100%;display:flex;flex-direction:column;overflow:hidden}[_nghost-%COMP%]     .p-card .p-card-body .p-card-content{flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0}[_nghost-%COMP%]     .chat-rooms-container{flex:1;overflow-y:auto;overflow-x:hidden;min-height:0;max-height:100%}[_nghost-%COMP%]     .chat-rooms-container::-webkit-scrollbar{width:6px}[_nghost-%COMP%]     .chat-rooms-container::-webkit-scrollbar-track{background:var(--surface-100);border-radius:3px}[_nghost-%COMP%]     .chat-rooms-container::-webkit-scrollbar-thumb{background:var(--surface-300);border-radius:3px}[_nghost-%COMP%]     .chat-rooms-container::-webkit-scrollbar-thumb:hover{background:var(--surface-400)}[_nghost-%COMP%]     .chat-room-item{transition:background-color .2s}[_nghost-%COMP%]     .chat-room-item:hover{background-color:var(--surface-100)}"]})};export{ae as MessageListComponent};
