<p-toast />
<p-confirm-dialog />

<div class="card" style="padding-left: 20px;
    padding-right: 10px;">
  <p-table [value]="filteredProjects"
           #dt2
            [scrollable]="true"
           scrollHeight="100vh"
           [tableStyle]="{ 'min-width': '100rem' }"
           [paginator]="true"
           [rows]="rows"
           [totalRecords]="totalRecords"
           [rowsPerPageOptions]="[ 10, 20, 30 ]"
           [lazy]="true"
           (onLazyLoad)="onLazyLoad($event)"
           [loading]="loading"
           [styleClass]="'p-datatable-sm'"
           >
    <ng-template pTemplate="caption">
      <div class="flex items-center justify-between" >
        <span class="text-xl font-bold">Projects</span>
      </div>

        <div class="flex align-items-end" style="padding-top: 15px; padding-bottom: 15px" >
          <p-button label="Add" icon="pi pi-plus" iconPos="right" size="small" (click)="onAddProject()" />
          <p-iconfield iconPosition="left" class="ml-auto">
            <p-inputicon>
              <i class="pi pi-search"></i>
            </p-inputicon>
            <input
              pInputText
              type="text"
              (input)="onSearch($event)"
              placeholder="Search "
            />
<!--            (input)="dt2.filterGlobal($event.target?.value, 'contains')"-->
          </p-iconfield>
        </div>
      </ng-template>
    <ng-template pTemplate="header">
            <tr>
              <th>Title</th>
              <th>Budget</th>
              <th>Deadline</th>
              <th>Client</th>
              <th>Created </th>
              <th>Updated </th>
              <th>Status</th>
              <th>Category</th>
              <th>Location</th>
              <th>Skills</th>
              <th>Freelancer</th>
              <th>Completed </th>
              <th>Featured</th>
              <th>Chat</th>
              <th class="stickh">Actions</th>
            </tr>
    </ng-template>
    <ng-template pTemplate="body" let-project>
            <tr>
              <td>
                <a 
                  class="text-primary cursor-pointer hover:text-primary-600 font-medium"
                  (click)="onViewProject(project)"
                  title="View Project Details">
                  {{ project.title }}
                </a>
              </td>
              <td>{{ project.budget }}</td>
              <td>{{ project.deadline | date:'short' }}</td>
              <td>{{ project.client?.username || project.client }}</td>
              <td>{{ project.created_at | date:'short' }}</td>
              <td>{{ project.updated_at | date:'short' }}</td>
              <td>{{ project.status }}</td>
              <td>{{ project.category?.name || project.category }}</td>
              <td>{{ project.location }}</td>
              <td>
                <ng-container *ngIf="project.skills_required && project.skills_required.length; else noSkills">
                  <span *ngFor="let skill of project.skills_required" class="skill">{{ skill }}</span>
                </ng-container>
                <ng-template #noSkills>-</ng-template>
              </td>
              <td>{{ project.selected_freelancer?.username || project.selected_freelancer || '-' }}</td>
              <td>{{ project.completed_at ? (project.completed_at | date:'short') : '-' }}</td>
              <td>{{ project.is_featured ? 'Yes' : 'No' }}</td>
              <td>
                <!-- Chat with Client (for freelancers) -->
                <button 
                  *ngIf="canChatWithClient(project)"
                  pButton 
                  type="button" 
                  icon="pi pi-comments" 
                  (click)="chatWithClient(project)"
                  class="p-button-sm p-button-outlined p-button-success"
                  title="Chat with Client"
                  label="Client">
                </button>
                
                <!-- Chat with Freelancer (for clients) -->
                <button 
                  *ngIf="canChatWithFreelancer(project)"
                  pButton 
                  type="button" 
                  icon="pi pi-comments" 
                  (click)="chatWithFreelancer(project)"
                  class="p-button-sm p-button-outlined p-button-info"
                  title="Chat with Freelancer"
                  label="Freelancer">
                </button>
                
                <!-- No chat available -->
                <span 
                  *ngIf="!canChatWithClient(project) && !canChatWithFreelancer(project)"
                  class="text-500 text-sm">
                  No active chat
                </span>
              </td>
              <td class="stick">
                <div class="flex gap-1">
                  <button pButton type="button" icon="pi pi-eye" (click)="onViewProject(project)" class="p-button-sm p-button-outlined p-button-info" title="View Details"></button>
                  <button pButton type="button" icon="pi pi-pencil" (click)="onEditProject(project)" class="p-button-sm p-button-outlined" title="Edit Project"></button>
                  <button pButton type="button" icon="pi pi-trash" (click)="delete($event, project)" class="p-button-sm p-button-danger p-button-outlined" title="Delete Project"></button>
                </div>
              </td>
            </tr>
    </ng-template>
    <ng-template pTemplate="empty">
      <tr>
        <td colspan="19" class="text-center">No data found</td>
      </tr>
    </ng-template>
<!--    <ng-template pTemplate="footer"> In total there are {{ products ? products.length : 0 }} products. </ng-template>-->
  </p-table>
</div>
